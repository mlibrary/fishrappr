!function(t){"use strict";function e(e){this.viewer.setMouseNavEnabled(!1),jQuery(this.toolbar).css("visibility","hidden");var i=this.viewer.viewport.deltaPointsFromPixels(e.delta,!0),n=this.viewer.viewport.pointFromPixel(e.position,!0),s=new t.Point(n.x-i.x,n.y-i.y);if(this.rect){var o;if(this.restrictToImage&&(o=this.rect.clone()),this.rectDone){var r=this.rect.getAngleFromCenter(s),h=this.rect.getAngleFromCenter(n);this.rect.rotation=(this.rect.rotation+r-h)%Math.PI}else this.startRotated?this.rect=l(this.rotatedStartPoint,n,this.startRotatedHeight):(this.rect.width+=i.x,this.rect.height+=i.y);this.restrictToImage&&!this.rect.fitsIn(new t.Rect(0,0,1,1))&&(this.rect=o)}else{if(this.restrictToImage){if(!a(s))return;c(i,n)}this.startRotated?(this.rotatedStartPoint=s,this.rect=l(s,n,this.startRotatedHeight)):this.rect=new t.SelectionRect(s.x,s.y,i.x,i.y),this.rectDone=!1}this.draw()}function i(){this.viewer.setMouseNavEnabled(!0),this.rectDone=!0;var t,e,i,n=jQuery(this.toolbar),s=function(t,e,i){i=i||0;var n="translate("+t+", "+e+")";return 0!=i&&(n+=" rotate("+i+"deg)"),n},o=n.height(),r=jQuery(this.element),h=jQuery(this.viewer.element),l=n.parent().height(),a=r.position().top+l,c=h.height(),d=1.1*r.height(),u=(r.width(),{}),g="0",w="50%",m=this.viewer.viewport.getRotation();d+a<c?(t=d+"px",e="",i="-50%"):a-d>o?(e=d+"px",t="",i="-50%"):(e="",t="50%",i="-50%",g="-50%"),0==m?(u.top=t,u.bottom=e,u.left=w,u.transform=s(i,g)):90==m?(u.top=e,u.bottom=w,u.left=-t,u.transform=s(g,i,-m)):180==m?(u.top=e,u.bottom=t,u.left=w,u.transform=s(i,g,-m)):270==m&&(u.top=w,u.bottom=e,u.left=-t,u.transform=s(i,g,-m)),u.visibility="visible",n.css(u),this.viewer.raiseEvent("selectionDrawn")}function n(){this.viewer.canvas.focus()}function s(e){t.addClass(this.element,"dragging");var i=this.viewer.viewport.deltaPointsFromPixels(e.delta,!0);this.rect.x+=i.x,this.rect.y+=i.y,this.restrictToImage&&!this.rect.fitsIn(new t.Rect(0,0,1,1))&&(this.rect.x-=i.x,this.rect.y-=i.y),this.draw()}function o(){t.removeClass(this.element,"dragging")}function r(e,i){var n,s=i.delta,o=this.rect.getDegreeRotation(),r=this.restrictToImage?this.rect.clone():null;switch(0!==o&&(s=s.rotate(-1*o,new t.Point(0,0)),n=this.rect.getCenter()),s=this.viewer.viewport.deltaPointsFromPixels(s,!0),e){case 0:this.rect.y+=s.y,this.rect.height-=s.y;break;case 1:this.rect.width+=s.x;break;case 2:this.rect.height+=s.y;break;case 3:this.rect.x+=s.x,this.rect.width-=s.x;break;case.5:this.rect.y+=s.y,this.rect.height-=s.y,this.rect.x+=s.x,this.rect.width-=s.x;break;case 1.5:this.rect.y+=s.y,this.rect.height-=s.y,this.rect.width+=s.x;break;case 2.5:this.rect.width+=s.x,this.rect.height+=s.y;break;case 3.5:this.rect.height+=s.y,this.rect.x+=s.x,this.rect.width-=s.x}if(0!==o){var h=this.rect.getCenter(),l=h.rotate(o,n);s=l.minus(h),this.rect.x+=s.x,this.rect.y+=s.y}this.restrictToImage&&!this.rect.fitsIn(new t.Rect(0,0,1,1))&&(this.rect=r),this.draw()}function h(t){var e=t.keyCode?t.keyCode:t.charCode;console.log("AHOY",e,t.keyCode,t.charCode),13===e?this.confirm():27==e?this.cancel():String.fromCharCode(e)===this.keyboardShortcut&&this.toggleState()}function l(e,i,n){if(e.x>i.x){var s=e;e=i,i=s}var o=i.minus(e),r=e.distanceTo(i),h=-1*Math.atan2(o.x,o.y)+Math.PI/2,l=new t.Point(o.x/2+e.x,o.y/2+e.y),a=new t.SelectionRect(l.x-r/2,l.y-n/2,r,n,h),c=new t.Point(0,n);return c=c.rotate(a.getDegreeRotation(),new t.Point(0,0)),a.x+=c.x/2,a.y+=c.y/2,a}function a(t){return t.x>=0&&t.x<=1&&t.y>=0&&t.y<=1}function c(t,e){var i;for(var n in{x:0,y:0})i=e[n]-t[n],i<1&&i>0&&(e[n]>1?(t[n]-=e[n]-1,e[n]=1):e[n]<0&&(t[n]-=e[n],e[n]=0))}if(!t.version||t.version.major<2)throw new Error("This version of OpenSeadragonSelection requires OpenSeadragon version 2.0.0+");t.Viewer.prototype.selection=function(e){return this.selectionInstance&&!e||(e=e||{},e.viewer=this,this.selectionInstance=new t.Selection(e)),this.selectionInstance},t.Selection=function(l){t.extend(!0,this,{viewer:null,isSelecting:!1,buttonActiveImg:!1,rectDone:!0,element:null,toggleButton:null,showSelectionControl:!0,showConfirmDenyButtons:!1,styleConfirmDenyButtons:!0,returnPixelCoordinates:!0,keyboardShortcut:"c",rect:null,startRotated:!1,startRotatedHeight:.1,restrictToImage:!1,onSelection:null,onSelectionDrawn:null,onDownloadSelection:null,onZoomSelection:null,onCancelSelection:null,prefixUrl:null,navImages:{selection:{REST:"selection_rest.png",GROUP:"selection_grouphover.png",HOVER:"selection_hover.png",DOWN:"selection_pressed.png"},selectionConfirm:{REST:"selection_confirm_rest.png",GROUP:"selection_confirm_grouphover.png",HOVER:"selection_confirm_hover.png",DOWN:"selection_confirm_pressed.png"},selectionCancel:{REST:"selection_cancel_rest.png",GROUP:"selection_cancel_grouphover.png",HOVER:"selection_cancel_hover.png",DOWN:"selection_cancel_pressed.png"}}},l),t.extend(!0,this.navImages,this.viewer.navImages),this.element||(this.element=t.makeNeutralElement("div"),this.element.style.background="rgba(0, 0, 0, 0.1)",this.element.className="selection-box"),this.borders=this.borders||[];for(var a,c=[],d=0;d<4;d++)this.borders[d]||(this.borders[d]=t.makeNeutralElement("div"),this.borders[d].className="border-"+d,this.borders[d].style.position="absolute",this.borders[d].style.width="1px",this.borders[d].style.height="1px",this.borders[d].style.background="#fff"),a=t.makeNeutralElement("div"),a.className="border-"+d+"-handle",a.style.position="absolute",a.style.top="50%",a.style.left="50%",a.style.width="6px",a.style.height="6px",a.style.margin="-4px 0 0 -4px",a.style.background="#000",a.style.border="1px solid #ccc",new t.MouseTracker({element:this.borders[d],dragHandler:r.bind(this,d)}),c[d]=t.makeNeutralElement("div"),c[d].className="corner-"+d+"-handle",c[d].style.position="absolute",c[d].style.width="6px",c[d].style.height="6px",c[d].style.background="#000",c[d].style.border="1px solid #ccc",new t.MouseTracker({element:c[d],dragHandler:r.bind(this,d+.5)}),this.borders[d].appendChild(a),this.element.appendChild(this.borders[d]),setTimeout(this.element.appendChild.bind(this.element,c[d]),0);this.borders[0].style.top=0,this.borders[0].style.width="100%",this.borders[1].style.right=0,this.borders[1].style.height="100%",this.borders[2].style.bottom=0,this.borders[2].style.width="100%",this.borders[3].style.left=0,this.borders[3].style.height="100%",c[0].style.top="-3px",c[0].style.left="-3px",c[1].style.top="-3px",c[1].style.right="-3px",c[2].style.bottom="-3px",c[2].style.right="-3px",c[3].style.bottom="-3px",c[3].style.left="-3px",this.overlay||(this.overlay=new t.SelectionOverlay(this.element,this.rect||new t.SelectionRect)),this.innerTracker=new t.MouseTracker({element:this.element,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,dragHandler:t.delegate(this,s),dragEndHandler:t.delegate(this,o),clickHandler:t.delegate(this,n)}),this.outerTracker=new t.MouseTracker({element:this.viewer.canvas,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,dragHandler:t.delegate(this,e),dragEndHandler:t.delegate(this,i),clickHandler:t.delegate(this,n),startDisabled:!this.isSelecting}),this.keyboardShortcut&&t.addEvent(this.viewer.container,"keypress",t.delegate(this,h),!1);var u=this.prefixUrl||this.viewer.prefixUrl||"",g=this.viewer.buttons&&this.viewer.buttons.buttons,w=g?this.viewer.buttons.buttons[0]:null,m=w?w.onFocus:null,v=w?w.onBlur:null;if(this.showSelectionControl&&(this.toggleButton=new t.Button({element:this.toggleButton?t.getElement(this.toggleButton):null,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,tooltip:t.getString("Tooltips.SelectionToggle")||"Toggle selection",srcRest:u+this.navImages.selection.REST,srcGroup:u+this.navImages.selection.GROUP,srcHover:u+this.navImages.selection.HOVER,srcDown:u+this.navImages.selection.DOWN,onRelease:this.toggleState.bind(this),onFocus:m,onBlur:v}),g&&(this.viewer.buttons.buttons.push(this.toggleButton),this.viewer.buttons.element.appendChild(this.toggleButton.element)),this.toggleButton.imgDown&&(this.buttonActiveImg=this.toggleButton.imgDown.cloneNode(!0),this.toggleButton.element.appendChild(this.buttonActiveImg))),this.showConfirmDenyButtons){var y=jQuery(".selection-toolbar").get(0);void 0===y&&(y=document.createElement("div"),y.className="selection-toolbar",y.style.position="absolute",y.style.width="30em",y.style.zIndex=9e3,y.style.textAlign="center",y.style.visibility="hidden",this.element.appendChild(y)),this.toolbar=y;var p=document.createElement("button");p.className="btn btn-sm btn-default",p.innerHTML='<i class="icon_add" aria-hidden="true"></i> Zoom In',this.zoomButton=new t.Button({element:p,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,onRelease:this.zoom.bind(this),onFocus:m,onBlur:v});var b="9em",f=this.zoomButton.element;y.appendChild(f),f.style.width=b,f.style.marginRight="0.25em",p=document.createElement("button"),p.className="btn btn-sm btn-default",p.innerHTML='<i class="icon_image_file" aria-hidden="true"></i> Download',this.downloadButton=new t.Button({element:p,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,onRelease:this.download.bind(this),onFocus:m,onBlur:v});var x=this.downloadButton.element;y.appendChild(x),x.style.width=b,x.style.marginRight="0.25em",p=document.createElement("button"),p.className="btn btn-sm btn-action",p.innerHTML="Cancel",this.cancelButton=new t.Button({element:p,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,onRelease:this.cancel.bind(this),onFocus:m,onBlur:v});var T=this.cancelButton.element;T.classList.add("cancel-button"),y.appendChild(T),T.style.width=b,y.style.position="absolute"}this.viewer.addHandler("selection",this.onSelection),this.viewer.addHandler("downloadSelection",this.onDownloadSelection),this.viewer.addHandler("zoomSelection",this.onZoomSelection),this.viewer.addHandler("cancelSelection",this.onCancelSelection),this.viewer.addHandler("selectionDrawn",this.onSelectionDrawn),this.viewer.addHandler("open",this.draw.bind(this)),this.viewer.addHandler("animation",this.draw.bind(this)),this.viewer.addHandler("resize",this.draw.bind(this)),this.viewer.addHandler("rotate",this.draw.bind(this))},t.extend(t.Selection.prototype,t.ControlDock.prototype,{toggleState:function(){return this.setState(!this.isSelecting)},setState:function(t){return this.isSelecting=t,this.outerTracker.setTracking(t),t?this.draw():this.undraw(),this.buttonActiveImg&&(this.buttonActiveImg.style.visibility=t?"visible":"hidden"),this.viewer.raiseEvent("selection_toggle",{enabled:t}),this},enable:function(){return this.setState(!0)},disable:function(){return this.setState(!1)},draw:function(){return this.rect&&(this.overlay.update(this.rect.normalize()),this.overlay.drawHTML(this.viewer.drawer.container,this.viewer.viewport)),this},undraw:function(){return this.overlay.destroy(),jQuery(this.toolbar).css("visibility","hidden"),this.rect=null,this},confirm:function(){if(this.rect){var e=this.rect.normalize();if(this.returnPixelCoordinates){var i=this.viewer.viewport.viewportToImageRectangle(e);i=t.SelectionRect.fromRect(i).round(),i.rotation=e.rotation,e=i}this.viewer.raiseEvent("selection",e),this.undraw()}return this},zoom:function(){if(this.rect){var e=this.rect.normalize();if(this.returnPixelCoordinates){var i=this.viewer.viewport.viewportToImageRectangle(e);i=t.SelectionRect.fromRect(i).round(),i.rotation=e.rotation,e=i}this.viewer.raiseEvent("zoomSelection",e),this.undraw()}return this},download:function(){if(this.rect){var e=this.rect.normalize();if(this.returnPixelCoordinates){var i=this.viewer.viewport.viewportToImageRectangle(e);i=t.SelectionRect.fromRect(i).round(),i.rotation=e.rotation,e=i}this.viewer.raiseEvent("downloadSelection",e),this.undraw()}return this},cancel:function(){return this.viewer.raiseEvent("cancelSelection",!1),this.undraw()}})}(OpenSeadragon),function(t){"use strict";t.SelectionOverlay=function(e,i){t.Overlay.apply(this,arguments),t.isPlainObject(e)?this.rotation=e.location.rotation||0:this.rotation=i.rotation||0},t.SelectionOverlay.prototype=t.extend(Object.create(t.Overlay.prototype),{drawHTML:function(){t.Overlay.prototype.drawHTML.apply(this,arguments),this.style.transform=this.style.transform.replace(/ ?rotate\(.+rad\)/,"")+" rotate("+this.rotation+"rad)"},update:function(e){t.Overlay.prototype.update.apply(this,arguments),this.rotation=e.rotation||0}})}(OpenSeadragon),function(t){"use strict";t.SelectionRect=function(e,i,n,s,o){t.Rect.apply(this,[e,i,n,s]),this.rotation=o||0},t.SelectionRect.fromRect=function(e){return new t.SelectionRect(e.x,e.y,e.width,e.height)},t.SelectionRect.prototype=t.extend(Object.create(t.Rect.prototype),{clone:function(){return new t.SelectionRect(this.x,this.y,this.width,this.height,this.rotation)},equals:function(e){return t.Rect.prototype.equals.apply(this,[e])&&this.rotation===e.rotation},toString:function(){return"["+Math.round(100*this.x)/100+","+Math.round(100*this.y)/100+","+Math.round(100*this.width)/100+"x"+Math.round(100*this.height)/100+"@"+Math.round(100*this.rotation)/100+"]"},swapWidthHeight:function(){var t=this.clone();return t.width=this.height,t.height=this.width,t.x+=(this.width-this.height)/2,t.y+=(this.height-this.width)/2,t},getDegreeRotation:function(){return this.rotation*(180/Math.PI)},getAngleFromCenter:function(t){var e=t.minus(this.getCenter());return Math.atan2(e.x,e.y)},round:function(){return new t.SelectionRect(Math.round(this.x),Math.round(this.y),Math.round(this.width),Math.round(this.height),this.rotation)},normalize:function(){var t=this.clone();return t.width<0&&(t.x+=t.width,t.width*=-1),t.height<0&&(t.y+=t.height,t.height*=-1),t.rotation%=Math.PI,t},fitsIn:function(t){for(var e=this.normalize(),i=[e.getTopLeft(),e.getTopRight(),e.getBottomRight(),e.getBottomLeft()],n=e.getCenter(),s=e.getDegreeRotation(),o=t.getBottomRight(),r=0;r<4;r++)if(i[r]=i[r].rotate(s,n),i[r].x<t.x||i[r].x>o.x||i[r].y<t.y||i[r].y>o.y)return!1;return!0},reduceRotation:function(){var t;return this.rotation<Math.PI/-4?(t=this.swapWidthHeight(),t.rotation+=Math.PI/2):this.rotation>Math.PI/4?(t=this.swapWidthHeight(),t.rotation-=Math.PI/2):t=this.clone(),t}})}(OpenSeadragon);
//# sourceMappingURL=openseadragonselection.js.map
